AWSTemplateFormatVersion: '2010-09-09'
Description: 'Amazon Q CLI SPOT FLEET V10 - US-WEST-2A ONLY: 8 Launch Configs in single AZ'

Parameters:
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: Name of an existing EC2 KeyPair
    Default: amazon-q-key-uswest2
  
  SpotPriceM5:
    Type: String
    Description: Maximum spot price for M5 instances
    Default: '0.400'
  
  SpotPriceM6i:
    Type: String
    Description: Maximum spot price for M6i instances
    Default: '0.350'
  
  SpotPriceC5:
    Type: String
    Description: Maximum spot price for C5 instances
    Default: '0.300'
  
  SpotPriceC6i:
    Type: String
    Description: Maximum spot price for C6i instances
    Default: '0.280'
  
  SpotPriceR5:
    Type: String
    Description: Maximum spot price for R5 instances
    Default: '0.450'
  
  SpotPriceR6i:
    Type: String
    Description: Maximum spot price for R6i instances
    Default: '0.400'
  
  SpotPriceT3:
    Type: String
    Description: Maximum spot price for T3 instances
    Default: '0.200'
  
  SpotPriceM6a:
    Type: String
    Description: Maximum spot price for M6a instances
    Default: '0.320'

Resources:
  # VPC
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: AmazonQ-SpotFleet-VPC-V10-1A-Only

  # Internet Gateway
  InternetGateway:
    Type: AWS::EC2::InternetGateway

  # Attach Gateway
  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  # Single Public Subnet in us-west-2a
  PublicSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: us-west-2a
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: AmazonQ-Public-Subnet-A-Only

  # Route Table
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: AmazonQ-Public-RouteTable-1A

  # Public Route
  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  # Associate Route Table
  PublicSubnetARouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnetA
      RouteTableId: !Ref PublicRouteTable

  # Security Group
  SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Amazon Q CLI Spot Fleet V10 - 1A Only
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
          Description: SSH access
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          CidrIp: 0.0.0.0/0
          Description: VS Code Server
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: HTTP
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
          Description: HTTPS
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: All outbound traffic
      Tags:
        - Key: Name
          Value: AmazonQ-SecurityGroup-V10-1A-Only

  # IAM Role for EC2 instances
  AdminRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AdministratorAccess
      Tags:
        - Key: Name
          Value: AmazonQ-AdminRole-V10-1A-Only

  # Instance Profile
  AdminInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref AdminRole

  # Elastic IP
  ElasticIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: AmazonQ-ElasticIP-V10-1A-Only

  # IAM Role for Spot Fleet
  SpotFleetRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: spotfleet.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEC2SpotFleetTaggingRole
      Tags:
        - Key: Name
          Value: AmazonQ-SpotFleetRole-V10-1A-Only

  # SPOT FLEET with 8 Launch Configurations - US-WEST-2A ONLY
  SpotFleet:
    Type: AWS::EC2::SpotFleet
    Properties:
      SpotFleetRequestConfigData:
        IamFleetRole: !GetAtt SpotFleetRole.Arn
        AllocationStrategy: diversified
        TargetCapacity: 1
        SpotPrice: '0.500'
        ReplaceUnhealthyInstances: true
        TerminateInstancesWithExpiration: false
        LaunchSpecifications:
          # M5 in us-west-2a (General Purpose)
          - ImageId: ami-0aff18ec83b712f05
            InstanceType: m5.2xlarge
            KeyName: !Ref KeyName
            SecurityGroups:
              - GroupId: !Ref SecurityGroup
            SubnetId: !Ref PublicSubnetA
            IamInstanceProfile:
              Arn: !GetAtt AdminInstanceProfile.Arn
            SpotPrice: !Ref SpotPriceM5
            WeightedCapacity: 1
            BlockDeviceMappings:
              - DeviceName: /dev/sda1
                Ebs:
                  VolumeSize: 40
                  VolumeType: gp3
                  DeleteOnTermination: true
                  Encrypted: true
            UserData:
              Fn::Base64: !Sub |
                #!/bin/bash -xe
                
                # Logging function
                log() {
                    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a /var/log/amazon-q-setup.log >&2
                }
                
                # Get instance metadata
                INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
                REGION=$(curl -s http://169.254.169.254/latest/meta-data/placement/region)
                INSTANCE_AZ=$(curl -s http://169.254.169.254/latest/meta-data/placement/availability-zone)
                
                log "ðŸš€ Starting Amazon Q CLI SPOT FLEET V10 setup on instance $INSTANCE_ID in AZ: $INSTANCE_AZ (m5 Family)"
                
                # Install essential tools
                log "ðŸ“¦ Installing essential tools..."
                apt-get update
                apt-get install -y unzip curl wget jq
                
                # Install AWS CLI
                log "ðŸ“¦ Installing AWS CLI..."
                curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
                unzip awscliv2.zip
                ./aws/install
                
                # INTELLIGENT VOLUME MANAGEMENT - PERSISTENT ACROSS AZs
                log "ðŸ’¾ Starting intelligent volume management..."
                
                # Look for existing available volume in same AZ
                log "ðŸ” Looking for existing volume in AZ: $INSTANCE_AZ"
                VOLUME_ID=$(aws ec2 describe-volumes \
                  --region $REGION \
                  --query "Volumes[?AvailabilityZone=='$INSTANCE_AZ' && Tags[?Key=='Purpose' && Value=='AmazonQ-CLI-Storage'] && State=='available']|[0].VolumeId" \
                  --output text)
                
                if [ "$VOLUME_ID" = "None" ] || [ -z "$VOLUME_ID" ]; then
                  log "ðŸ†• Creating fresh volume in AZ $INSTANCE_AZ"
                  VOLUME_ID=$(aws ec2 create-volume \
                    --region $REGION \
                    --availability-zone $INSTANCE_AZ \
                    --size 30 \
                    --volume-type gp3 \
                    --encrypted \
                    --tag-specifications "ResourceType=volume,Tags=[{Key=Name,Value=AmazonQ-PersistentData},{Key=Purpose,Value=AmazonQ-CLI-Storage}]" \
                    --query 'VolumeId' \
                    --output text)
                  
                  log "â³ Waiting for volume $VOLUME_ID to be available..."
                  aws ec2 wait volume-available --region $REGION --volume-ids $VOLUME_ID
                  log "âœ… Created fresh volume: $VOLUME_ID"
                else
                  log "âœ… Found existing volume: $VOLUME_ID"
                fi
                
                # Attach volume
                log "ðŸ”— Attaching volume $VOLUME_ID to instance $INSTANCE_ID"
                aws ec2 attach-volume \
                  --region $REGION \
                  --volume-id $VOLUME_ID \
                  --instance-id $INSTANCE_ID \
                  --device /dev/xvdf
                
                log "â³ Waiting for volume attachment..."
                aws ec2 wait volume-in-use --region $REGION --volume-ids $VOLUME_ID
                
                # Detect device name
                log "ðŸ” Detecting device name..."
                sleep 10
                DEVICE_NAME=""
                for i in {1..10}; do
                  if [ -b "/dev/xvdf" ]; then
                    DEVICE_NAME="/dev/xvdf"
                    break
                  elif [ -b "/dev/nvme1n1" ]; then
                    DEVICE_NAME="/dev/nvme1n1"
                    break
                  else
                    sleep 1
                  fi
                done
                
                if [ -z "$DEVICE_NAME" ]; then
                  log "âŒ Could not find attached volume device"
                  exit 1
                fi
                
                log "ðŸ“ Device found at: $DEVICE_NAME"
                
                # Create filesystem if needed
                if ! blkid $DEVICE_NAME; then
                  log "ðŸ”§ Creating filesystem on new volume..."
                  mkfs.ext4 $DEVICE_NAME
                fi
                
                # Mount volume
                log "ðŸ“‚ Mounting volume..."
                mkdir -p /persistent
                mount $DEVICE_NAME /persistent
                UUID=$(blkid -s UUID -o value $DEVICE_NAME)
                echo "UUID=$UUID /persistent ext4 defaults 0 2" >> /etc/fstab
                
                # Associate Elastic IP
                log "ðŸŒ Associating Elastic IP..."
                aws ec2 associate-address \
                  --region $REGION \
                  --instance-id $INSTANCE_ID \
                  --allocation-id ${ElasticIP.AllocationId}
                
                # Download and execute V10 ENHANCED setup script from PUBLIC S3
                log "ðŸ“¥ Downloading V10 ENHANCED setup script with complete 17 MCP servers..."
                curl -o /tmp/user-data-script-s3copy.sh "https://s3.us-west-2.amazonaws.com/03-july-2025-qclvscodespot-4.14pm/user-data-script-s3copy.sh"
                chmod +x /tmp/user-data-script-s3copy.sh
                /tmp/user-data-script-s3copy.sh
                
                # Signal completion
                log "ðŸŽ‰ V10 ENHANCED Setup completed successfully for m5!"
                echo "SETUP_SUCCESS_V10_ENHANCED_M5" > /tmp/setup-status.txt
                log "âœ… Amazon Q CLI + VS Code Server V10 ENHANCED Setup Complete with 17 MCP Servers!"
            TagSpecifications:
              - ResourceType: instance
                Tags:
                  - Key: Name
                    Value: AmazonQ-CLI-VSCode-V10-m5.2xlarge-us-west-2a
                  - Key: Fleet
                    Value: AmazonQ-SpotFleet-V10-1A-Only

          # M6I in us-west-2a (Latest General Purpose)
          - ImageId: ami-0aff18ec83b712f05
            InstanceType: m6i.2xlarge
            KeyName: !Ref KeyName
            SecurityGroups:
              - GroupId: !Ref SecurityGroup
            SubnetId: !Ref PublicSubnetA
            IamInstanceProfile:
              Arn: !GetAtt AdminInstanceProfile.Arn
            SpotPrice: !Ref SpotPriceM6i
            WeightedCapacity: 1
            BlockDeviceMappings:
              - DeviceName: /dev/sda1
                Ebs:
                  VolumeSize: 40
                  VolumeType: gp3
                  DeleteOnTermination: true
                  Encrypted: true
            UserData:
              Fn::Base64: !Sub |
                #!/bin/bash -xe
                log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a /var/log/amazon-q-setup.log >&2; }
                INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
                REGION=$(curl -s http://169.254.169.254/latest/meta-data/placement/region)
                INSTANCE_AZ=$(curl -s http://169.254.169.254/latest/meta-data/placement/availability-zone)
                log "ðŸš€ Starting Amazon Q CLI setup on m6i.2xlarge in us-west-2a"
                apt-get update && apt-get install -y unzip curl wget jq
                curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" && unzip awscliv2.zip && ./aws/install
                
                # PERSISTENT VOLUME LOGIC
                log "ðŸ’¾ Starting volume management..."
                VOLUME_ID=$(aws ec2 describe-volumes --region $REGION --query "Volumes[?AvailabilityZone=='$INSTANCE_AZ' && Tags[?Key=='Purpose' && Value=='AmazonQ-CLI-Storage'] && State=='available']|[0].VolumeId" --output text)
                if [ "$VOLUME_ID" = "None" ] || [ -z "$VOLUME_ID" ]; then
                  VOLUME_ID=$(aws ec2 create-volume --region $REGION --availability-zone $INSTANCE_AZ --size 30 --volume-type gp3 --encrypted --tag-specifications "ResourceType=volume,Tags=[{Key=Name,Value=AmazonQ-PersistentData},{Key=Purpose,Value=AmazonQ-CLI-Storage}]" --query 'VolumeId' --output text)
                  aws ec2 wait volume-available --region $REGION --volume-ids $VOLUME_ID
                fi
                aws ec2 attach-volume --region $REGION --volume-id $VOLUME_ID --instance-id $INSTANCE_ID --device /dev/xvdf
                aws ec2 wait volume-in-use --region $REGION --volume-ids $VOLUME_ID
                sleep 10
                DEVICE_NAME="/dev/xvdf"; [ -b "/dev/nvme1n1" ] && DEVICE_NAME="/dev/nvme1n1"
                [ ! "$(blkid $DEVICE_NAME)" ] && mkfs.ext4 $DEVICE_NAME
                mkdir -p /persistent && mount $DEVICE_NAME /persistent
                echo "UUID=$(blkid -s UUID -o value $DEVICE_NAME) /persistent ext4 defaults 0 2" >> /etc/fstab
                
                aws ec2 associate-address --region $REGION --instance-id $INSTANCE_ID --allocation-id ${ElasticIP.AllocationId}
                curl -o /tmp/user-data-script-s3copy.sh "https://s3.us-west-2.amazonaws.com/03-july-2025-qclvscodespot-4.14pm/user-data-script-s3copy.sh"
                chmod +x /tmp/user-data-script-s3copy.sh && /tmp/user-data-script-s3copy.sh
                log "âœ… M6I Setup Complete!"
            TagSpecifications:
              - ResourceType: instance
                Tags:
                  - Key: Name
                    Value: AmazonQ-CLI-VSCode-V10-m6i.2xlarge-us-west-2a
                  - Key: Fleet
                    Value: AmazonQ-SpotFleet-V10-1A-Only

          # C5 in us-west-2a (Compute Optimized)
          - ImageId: ami-0aff18ec83b712f05
            InstanceType: c5.2xlarge
            KeyName: !Ref KeyName
            SecurityGroups:
              - GroupId: !Ref SecurityGroup
            SubnetId: !Ref PublicSubnetA
            IamInstanceProfile:
              Arn: !GetAtt AdminInstanceProfile.Arn
            SpotPrice: !Ref SpotPriceC5
            WeightedCapacity: 1
            BlockDeviceMappings:
              - DeviceName: /dev/sda1
                Ebs:
                  VolumeSize: 40
                  VolumeType: gp3
                  DeleteOnTermination: true
                  Encrypted: true
            UserData:
              Fn::Base64: !Sub |
                #!/bin/bash -xe
                log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a /var/log/amazon-q-setup.log >&2; }
                INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
                REGION=$(curl -s http://169.254.169.254/latest/meta-data/placement/region)
                log "ðŸš€ Starting Amazon Q CLI setup on c5.2xlarge in us-west-2a"
                apt-get update && apt-get install -y unzip curl wget jq
                curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" && unzip awscliv2.zip && ./aws/install
                aws ec2 associate-address --region $REGION --instance-id $INSTANCE_ID --allocation-id ${ElasticIP.AllocationId}
                curl -o /tmp/user-data-script-s3copy.sh "https://s3.us-west-2.amazonaws.com/03-july-2025-qclvscodespot-4.14pm/user-data-script-s3copy.sh"
                chmod +x /tmp/user-data-script-s3copy.sh && /tmp/user-data-script-s3copy.sh
                log "âœ… C5 Setup Complete!"
            TagSpecifications:
              - ResourceType: instance
                Tags:
                  - Key: Name
                    Value: AmazonQ-CLI-VSCode-V10-c5.2xlarge-us-west-2a
                  - Key: Fleet
                    Value: AmazonQ-SpotFleet-V10-1A-Only

          # C6I in us-west-2a (Latest Compute Optimized)
          - ImageId: ami-0aff18ec83b712f05
            InstanceType: c6i.2xlarge
            KeyName: !Ref KeyName
            SecurityGroups:
              - GroupId: !Ref SecurityGroup
            SubnetId: !Ref PublicSubnetA
            IamInstanceProfile:
              Arn: !GetAtt AdminInstanceProfile.Arn
            SpotPrice: !Ref SpotPriceC6i
            WeightedCapacity: 1
            BlockDeviceMappings:
              - DeviceName: /dev/sda1
                Ebs:
                  VolumeSize: 40
                  VolumeType: gp3
                  DeleteOnTermination: true
                  Encrypted: true
            UserData:
              Fn::Base64: !Sub |
                #!/bin/bash -xe
                log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a /var/log/amazon-q-setup.log >&2; }
                INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
                REGION=$(curl -s http://169.254.169.254/latest/meta-data/placement/region)
                log "ðŸš€ Starting Amazon Q CLI setup on c6i.2xlarge in us-west-2a"
                apt-get update && apt-get install -y unzip curl wget jq
                curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" && unzip awscliv2.zip && ./aws/install
                aws ec2 associate-address --region $REGION --instance-id $INSTANCE_ID --allocation-id ${ElasticIP.AllocationId}
                curl -o /tmp/user-data-script-s3copy.sh "https://s3.us-west-2.amazonaws.com/03-july-2025-qclvscodespot-4.14pm/user-data-script-s3copy.sh"
                chmod +x /tmp/user-data-script-s3copy.sh && /tmp/user-data-script-s3copy.sh
                log "âœ… C6I Setup Complete!"
            TagSpecifications:
              - ResourceType: instance
                Tags:
                  - Key: Name
                    Value: AmazonQ-CLI-VSCode-V10-c6i.2xlarge-us-west-2a
                  - Key: Fleet
                    Value: AmazonQ-SpotFleet-V10-1A-Only

          # R5 in us-west-2a (Memory Optimized)
          - ImageId: ami-0aff18ec83b712f05
            InstanceType: r5.2xlarge
            KeyName: !Ref KeyName
            SecurityGroups:
              - GroupId: !Ref SecurityGroup
            SubnetId: !Ref PublicSubnetA
            IamInstanceProfile:
              Arn: !GetAtt AdminInstanceProfile.Arn
            SpotPrice: !Ref SpotPriceR5
            WeightedCapacity: 1
            BlockDeviceMappings:
              - DeviceName: /dev/sda1
                Ebs:
                  VolumeSize: 40
                  VolumeType: gp3
                  DeleteOnTermination: true
                  Encrypted: true
            UserData:
              Fn::Base64: !Sub |
                #!/bin/bash -xe
                log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a /var/log/amazon-q-setup.log >&2; }
                INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
                REGION=$(curl -s http://169.254.169.254/latest/meta-data/placement/region)
                log "ðŸš€ Starting Amazon Q CLI setup on r5.2xlarge in us-west-2a"
                apt-get update && apt-get install -y unzip curl wget jq
                curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" && unzip awscliv2.zip && ./aws/install
                aws ec2 associate-address --region $REGION --instance-id $INSTANCE_ID --allocation-id ${ElasticIP.AllocationId}
                curl -o /tmp/user-data-script-s3copy.sh "https://s3.us-west-2.amazonaws.com/03-july-2025-qclvscodespot-4.14pm/user-data-script-s3copy.sh"
                chmod +x /tmp/user-data-script-s3copy.sh && /tmp/user-data-script-s3copy.sh
                log "âœ… R5 Setup Complete!"
            TagSpecifications:
              - ResourceType: instance
                Tags:
                  - Key: Name
                    Value: AmazonQ-CLI-VSCode-V10-r5.2xlarge-us-west-2a
                  - Key: Fleet
                    Value: AmazonQ-SpotFleet-V10-1A-Only

          # R6I in us-west-2a (Latest Memory Optimized)
          - ImageId: ami-0aff18ec83b712f05
            InstanceType: r6i.2xlarge
            KeyName: !Ref KeyName
            SecurityGroups:
              - GroupId: !Ref SecurityGroup
            SubnetId: !Ref PublicSubnetA
            IamInstanceProfile:
              Arn: !GetAtt AdminInstanceProfile.Arn
            SpotPrice: !Ref SpotPriceR6i
            WeightedCapacity: 1
            BlockDeviceMappings:
              - DeviceName: /dev/sda1
                Ebs:
                  VolumeSize: 40
                  VolumeType: gp3
                  DeleteOnTermination: true
                  Encrypted: true
            UserData:
              Fn::Base64: !Sub |
                #!/bin/bash -xe
                log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a /var/log/amazon-q-setup.log >&2; }
                INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
                REGION=$(curl -s http://169.254.169.254/latest/meta-data/placement/region)
                log "ðŸš€ Starting Amazon Q CLI setup on r6i.2xlarge in us-west-2a"
                apt-get update && apt-get install -y unzip curl wget jq
                curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" && unzip awscliv2.zip && ./aws/install
                aws ec2 associate-address --region $REGION --instance-id $INSTANCE_ID --allocation-id ${ElasticIP.AllocationId}
                curl -o /tmp/user-data-script-s3copy.sh "https://s3.us-west-2.amazonaws.com/03-july-2025-qclvscodespot-4.14pm/user-data-script-s3copy.sh"
                chmod +x /tmp/user-data-script-s3copy.sh && /tmp/user-data-script-s3copy.sh
                log "âœ… R6I Setup Complete!"
            TagSpecifications:
              - ResourceType: instance
                Tags:
                  - Key: Name
                    Value: AmazonQ-CLI-VSCode-V10-r6i.2xlarge-us-west-2a
                  - Key: Fleet
                    Value: AmazonQ-SpotFleet-V10-1A-Only

          # T3 in us-west-2a (Burstable Performance)
          - ImageId: ami-0aff18ec83b712f05
            InstanceType: t3.2xlarge
            KeyName: !Ref KeyName
            SecurityGroups:
              - GroupId: !Ref SecurityGroup
            SubnetId: !Ref PublicSubnetA
            IamInstanceProfile:
              Arn: !GetAtt AdminInstanceProfile.Arn
            SpotPrice: !Ref SpotPriceT3
            WeightedCapacity: 1
            BlockDeviceMappings:
              - DeviceName: /dev/sda1
                Ebs:
                  VolumeSize: 40
                  VolumeType: gp3
                  DeleteOnTermination: true
                  Encrypted: true
            UserData:
              Fn::Base64: !Sub |
                #!/bin/bash -xe
                log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a /var/log/amazon-q-setup.log >&2; }
                INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
                REGION=$(curl -s http://169.254.169.254/latest/meta-data/placement/region)
                log "ðŸš€ Starting Amazon Q CLI setup on t3.2xlarge in us-west-2a"
                apt-get update && apt-get install -y unzip curl wget jq
                curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" && unzip awscliv2.zip && ./aws/install
                aws ec2 associate-address --region $REGION --instance-id $INSTANCE_ID --allocation-id ${ElasticIP.AllocationId}
                curl -o /tmp/user-data-script-s3copy.sh "https://s3.us-west-2.amazonaws.com/03-july-2025-qclvscodespot-4.14pm/user-data-script-s3copy.sh"
                chmod +x /tmp/user-data-script-s3copy.sh && /tmp/user-data-script-s3copy.sh
                log "âœ… T3 Setup Complete!"
            TagSpecifications:
              - ResourceType: instance
                Tags:
                  - Key: Name
                    Value: AmazonQ-CLI-VSCode-V10-t3.2xlarge-us-west-2a
                  - Key: Fleet
                    Value: AmazonQ-SpotFleet-V10-1A-Only

          # M6A in us-west-2a (AMD General Purpose)
          - ImageId: ami-0aff18ec83b712f05
            InstanceType: m6a.2xlarge
            KeyName: !Ref KeyName
            SecurityGroups:
              - GroupId: !Ref SecurityGroup
            SubnetId: !Ref PublicSubnetA
            IamInstanceProfile:
              Arn: !GetAtt AdminInstanceProfile.Arn
            SpotPrice: !Ref SpotPriceM6a
            WeightedCapacity: 1
            BlockDeviceMappings:
              - DeviceName: /dev/sda1
                Ebs:
                  VolumeSize: 40
                  VolumeType: gp3
                  DeleteOnTermination: true
                  Encrypted: true
            UserData:
              Fn::Base64: !Sub |
                #!/bin/bash -xe
                log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a /var/log/amazon-q-setup.log >&2; }
                INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
                REGION=$(curl -s http://169.254.169.254/latest/meta-data/placement/region)
                log "ðŸš€ Starting Amazon Q CLI setup on m6a.2xlarge in us-west-2a"
                apt-get update && apt-get install -y unzip curl wget jq
                curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" && unzip awscliv2.zip && ./aws/install
                aws ec2 associate-address --region $REGION --instance-id $INSTANCE_ID --allocation-id ${ElasticIP.AllocationId}
                curl -o /tmp/user-data-script-s3copy.sh "https://s3.us-west-2.amazonaws.com/03-july-2025-qclvscodespot-4.14pm/user-data-script-s3copy.sh"
                chmod +x /tmp/user-data-script-s3copy.sh && /tmp/user-data-script-s3copy.sh
                log "âœ… M6A Setup Complete!"
            TagSpecifications:
              - ResourceType: instance
                Tags:
                  - Key: Name
                    Value: AmazonQ-CLI-VSCode-V10-m6a.2xlarge-us-west-2a
                  - Key: Fleet
                    Value: AmazonQ-SpotFleet-V10-1A-Only

Outputs:
  ElasticIP:
    Description: Elastic IP address for the instance
    Value: !Ref ElasticIP
    Export:
      Name: !Sub "${AWS::StackName}-ElasticIP"

  VSCodeServerURL:
    Description: VS Code Server URL
    Value: !Sub "http://${ElasticIP}:8080"
    Export:
      Name: !Sub "${AWS::StackName}-VSCodeURL"

  SSHCommand:
    Description: SSH command to connect to the instance
    Value: !Sub "ssh -i ${KeyName}.pem ubuntu@${ElasticIP}"
    Export:
      Name: !Sub "${AWS::StackName}-SSHCommand"

  SpotFleetId:
    Description: Spot Fleet Request ID
    Value: !Ref SpotFleet
    Export:
      Name: !Sub "${AWS::StackName}-SpotFleetId"

  InstanceFamilies:
    Description: Instance families configured
    Value: "M5, M6i, C5, C6i, R5, R6i, T3, M6a"
    Export:
      Name: !Sub "${AWS::StackName}-InstanceFamilies"

  AvailabilityZone:
    Description: Availability zone used
    Value: "us-west-2a"
    Export:
      Name: !Sub "${AWS::StackName}-AvailabilityZone"
